---
description: Structured REFACTOR workflow: preserve observable behaviour while
  improving design, readability, performance, or maintainability.
globs: 
alwaysApply: false
type: Manual
---

# Approach:

â‘  Scouting Phase (â€œAssessâ€)
â€¢ **No production code changes** yet.  
 â€¢ Identify smells (duplication, long methods, feature envy, etc.) and
map the dependency graph of the area in question.  
 â€¢ Produce a **Refactor Plan** containing:  
 â€“ Goals (e.g. â€œextract domain objectâ€, â€œreplace inheritance with
compositionâ€)  
 â€“ Risky hotspots (global state, reflection, meta-prog)  
 â€“ Current test-coverage gaps (add â€œcharacterisationâ€ tests if
needed)  
 â€“ Performance constraints and rollback strategy  
 â€¢ Wait for **â€œApprove refactor planâ€**.
â‘¡ Guardrail Phase (â€œSafety Netâ€)
â€¢ Add or extend tests to lock in todayâ€™s behaviour (characterisation).  
 â€¢ Suite MUST pass exactly as before.  
 â€¢ Pause for **â€œApprove safety netâ€**.
â‘¢ Refactor Phase (â€œCodeâ€)
â€¢ Micro-TDD slices (<200 LOC/commit):
â€¢ Strictly follow principles: KISS, YAGNI, DRY, SOLID, CLEAN CODE, etc.

1.  Run suite (should pass)
2.  Apply a single small refactor (rename, extract method, etc.)
3.  Re-run suite; if green, commit.  
     â€¢ After each slice: explain intent, DRY/SOLID impact, perf delta.  
     â€¢ Wait for **â€œApply slice Nâ€** after every diff set.
    â‘£ Finalise
    â€¢ Remove dead code, update docs/comments.  
     â€¢ Run full suite + linter + perf benchmarks; present report.  
     â€¢ Await **â€œShip itâ€** before merge.

# ğŸ”„ Refactor-First Workflow

## 0ï¸âƒ£ Trigger

_â€œrefactorâ€ label, tech-debt ticket, or reviewer request._

## 1ï¸âƒ£ Scouting Phase (Assess)

1. Walk the code; list smells + dependencies.
2. Draft **Refactor Plan** (goals, risks, coverage gaps).
3. â†ªï¸ _Wait for_ **â€œApprove refactor planâ€**.

## 2ï¸âƒ£ Guardrail Phase (Safety Net)

1. Add/extend characterisation tests where coverage < 80 %.
2. Ensure suite still green.
3. â†ªï¸ _Wait for_ **â€œApprove safety netâ€**.

## 3ï¸âƒ£ Refactor Phase (Code)

_Repeat micro-TDD loop until goals met._

| Step           | LOC limit              |
| -------------- | ---------------------- |
| Diff per slice | â‰¤ 120 (tests + prod)   |
| Commit msg     | imperative, â‰¤ 72 chars |

â†ªï¸ _Pause for_ **â€œApply slice Nâ€** after each iteration.

## 4ï¸âƒ£ Finalise

_Run suite, lint, perf check â†’ report â†’ â€œShip itâ€._

## Conversation Rules

1. **No behavioural change** allowed; if behaviour _must_ change,
   escalate back to a feature or bug-fix rule.
2. Ask clarifying questions whenever context is ambiguous.
3. Keep suite green & linter clean at every pause.
4. Cite docs only in explanations, not in commit messages.
5. Explicit approvals gate each phase: **Assess â†’ Safety Net â†’ Code â†’ Ship**.
6. Git

_End of rule._
